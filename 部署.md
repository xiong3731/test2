[https://ones.dml.ucloud.cn/wiki/#/team/BVSybaCU/space/5Q4QShfa/page/9kszmeoV](https://ones.dml.ucloud.cn/wiki/#/team/BVSybaCU/space/5Q4QShfa/page/9kszmeoV)

### mongo实例
| <font style="color:rgb(82, 96, 117);">IP地址</font> | <font style="color:rgb(82, 96, 117);">IPv6地址</font> | <font style="color:rgb(82, 96, 117);">Hostname</font> | <font style="color:rgb(82, 96, 117);">可用区</font> | <font style="color:rgb(82, 96, 117);">CPU</font> | <font style="color:rgb(82, 96, 117);">MEM</font> | <font style="color:rgb(82, 96, 117);">DiSK</font> | <font style="color:rgb(82, 96, 117);">状态</font> |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| <font style="color:rgb(10, 22, 51);">10.70.41.172</font> | <font style="color:rgb(10, 22, 51);">2002:0a46:29ac::1</font> | <font style="color:rgb(10, 22, 51);">prod-10.70.41.172</font> | <font style="color:rgb(10, 22, 51);">NA04</font> | <font style="color:rgb(10, 22, 51);">4C</font> | <font style="color:rgb(10, 22, 51);">8G</font> | <font style="color:rgb(10, 22, 51);">200G</font> | <font style="color:rgb(10, 22, 51);">运行中</font> |
| <font style="color:rgb(10, 22, 51);">10.70.41.173</font> | <font style="color:rgb(10, 22, 51);">2002:0a46:29ad::1</font> | <font style="color:rgb(10, 22, 51);">prod-10.70.41.173</font> | <font style="color:rgb(10, 22, 51);">NA04</font> | <font style="color:rgb(10, 22, 51);">4C</font> | <font style="color:rgb(10, 22, 51);">8G</font> | <font style="color:rgb(10, 22, 51);">200G</font> | <font style="color:rgb(10, 22, 51);">运行中</font> |
| <font style="color:rgb(10, 22, 51);">10.70.36.150</font> | <font style="color:rgb(10, 22, 51);">2002:0a46:2496::1</font> | <font style="color:rgb(10, 22, 51);">prod-10.70.36.150</font> | <font style="color:rgb(10, 22, 51);">NA04</font> | <font style="color:rgb(10, 22, 51);">4C</font> | <font style="color:rgb(10, 22, 51);">8G</font> | <font style="color:rgb(10, 22, 51);">200G</font> | <font style="color:rgb(10, 22, 51);">运行中</font> |




### step1 : 在控制台创建好mysql;uk8s(使用统一的公钥)
```yaml
kind: Config
clusters:
- name: uminfer-nGAawqjs
  cluster:
    server: https://107.150.104.109:6443
    certificate-authority-data: LS0tLS1C*****tCg==
users:
- name: 151157843-1757925682
  user:
    client-certificate-data: LS0tLS1CRUdJT*****LS0tLQo=
    client-key-data: LS0tLS1CRUd*****JTQSBQUklWQVRFIEtFWS0tLS0tCg==
contexts:
- name: uminfer-nGAawqjs
  context:
    cluster: uminfer-nGAawqjs
    user: 151157843-1757925682
current-context: uminfer-nGAawqjs

```

###   
step2 : 在uk8s 上部署好ingress,ingress用外网的,得到一个外网ip,ingress 要开一下nodeexporter
> 仅供参考 -> [http://modelverse2.page.ucloudadmin.com/docs/#/deploy/deploy?id=ingress](http://modelverse2.page.ucloudadmin.com/docs/#/deploy/deploy?id=ingress)
>

```yaml
kubectl apply -f https://docs.ucloud.cn/uk8s/yaml/ingress_nginx/mandatory_1.26.yaml
```

```yaml
 kubectl edit deployment  ingress-nginx-controller -n ingress-nginx
```

> <font style="color:rgba(0, 0, 0, 0.85);">添加 </font>`<font style="color:rgb(0, 0, 0);">spec.template.spec.containers[0].ports</font>`<font style="color:rgba(0, 0, 0, 0.85);">  Exporter 端口：</font>
>

```yaml
ports:
- name: metrics  # 端口名，便于识别
  containerPort: 10254  # Exporter默认端口
  protocol: TCP
```



```yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    "service.beta.kubernetes.io/ucloud-load-balancer-type": "outer"
    "service.beta.kubernetes.io/ucloud-load-balancer-listentype": "network" 
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.11.5
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  externalTrafficPolicy: Local
  ports:
  - appProtocol: http
    name: http
    port: 80
    protocol: TCP
    targetPort: http
  - appProtocol: https
    name: https
    port: 443
    protocol: TCP
    targetPort: https
  - name: prometheus
    nodePort: 30993
    port: 10254
    protocol: TCP
  selector:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
  type: LoadBalancer

```

> 添加metadata.annotations 开放nlb
>
> 添加spec.ports 开放nodeport端口
>



### step3: 外网ip解析一下, 先发邮件,再cname
例如本次部署

```plain
ingress 的 外部ip是 107.150.100.82
域名是 api.umodelverse.ai
```

#### 3.1 发邮件
![](https://cdn.nlark.com/yuque/0/2025/png/36178385/1758870931512-542e6da2-ac6d-4a0e-b684-14276e7f7627.png)



```yaml
kubectl create ns uminfer

kubectl create secret tls uminfer-cert-20250926 --cert=umodelverse-ai-0923142839_chain.pem  --key=umodelverse-ai-0923142839_key.key -n uminfer -o yaml --dry-run=server >uminfer-cert-secrets.yaml

kubectl apply -f uminfer-cert-secrets.yaml
```

```yaml


apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: uminfer-api-ingress
  namespace: uminfer
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: 100m
    nginx.ingress.kubernetes.io/proxy-connect-timeout: '300'
    nginx.ingress.kubernetes.io/proxy-read-timeout: '300'
    nginx.ingress.kubernetes.io/proxy-send-timeout: '300'
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - api.modelverse.cn
      secretName: uminfer-cert-20250926
  rules:
    - host: api.umodelverse.ai
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: uminfer-proxy
                port:
                  number: 80
```

配置完后nslookup一下



```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app: ingress-nginx
  name: ingress-nginx
spec:
  endpoints:
  - port: "prometheus"
    path: /metrics
  jobLabel: jobLabel
  namespaceSelector:
    matchNames:
    - uminfer
  selector:
    matchLabels:
      app.kubernetes.io/name: ingress-nginx

```

### step4: 创建prometheus
### step5: 填写deploy/deploy-inference-service-prod.yaml的config,然后部署
> [https://git.ucloudadmin.com/modelverse2/inference-service/-/blob/main/deploy/deploy-inference-service-prod.yaml](https://git.ucloudadmin.com/modelverse2/inference-service/-/blob/main/deploy/deploy-inference-service-prod.yaml)
>
> [https://git.ucloudadmin.com/modelverse2/inference-service/-/blob/main/deploy/deploy-inference-service-gray.yaml](https://git.ucloudadmin.com/modelverse2/inference-service/-/blob/main/deploy/deploy-inference-service-gray.yaml)
>

```yaml
data:
  config.yaml: |
    addr: ":8080"
    # 这个是mongo的集群
    mongo: "mongodb://admin:^K******P1@10.70.41.172:27017,10.70.41.173:27017,10.70.36.150:27017"
    gw: "http://internal.api.ucloud.cn"
    # 不用改
    uresourceKey: "dfe3g4rd332fddad"
    # 不用改,能保证通这个域名就行
    ufmodel: "http://ufactory-api-svc.prj-ufactory.svc.c5.uae:9002"
    # 替换为step3里的新的域名
    uminferProxyAddr: "https://api.umodelverse.ai/admin" 
    # 不用改
    uminferProxyKey: "f01578b7c81b4b83817ca3863d4acb1a"
    # $(kubectl get svc -n uk8s-monitor uk8s-prometheus) 得到的ip,kun小工具转换一下
    prometheus: "http://[2003:da8:2004:1000:0a0b:0204:051a:c7b9]:9090"
    # 不用改
    kubeconfig: "/etc/uminfer/kubeconfig"
    # 改成集群的id
    uk8sID: "uk8s-1guebktjtdmb"
  kubeconfig: |-
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data:  xxxx
        # kun小工具转换一下
        server: https://[2003:da8:2004:1000:0a3c:5665:2712:f9c1]:6443
      name: kubernetes
```

> rbac要用admin部署一下
>

### step6: 格式化mysql
```yaml
登录华北2的mysql,拿到表结构 EC******AUZ9

ssh -i ~/.ssh/b13-modelverse.key 117.50.187.25

mysqldump -h 10.60.117.248 -u root -p   --no-data   --set-gtid-purged=OFF   --column-statistics=0   aigc_modelverse > aigc_modelverse_schema.sql

# 洛杉矶跳板机
107.150.99.175 

mysql -h 10.11.13.115 -u root -p

CREATE DATABASE aigc_modelverse CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

mysql -h 10.11.13.115 -u root -p aigc_modelverse  < aigc_modelverse_schema.sql

# 检查从库
mysql -h 10.11.31.42  -u root -p
```

### step7: 部署proxy
> [https://git.ucloudadmin.com/aigc/modelverseserver/-/blob/main/deploy/deploy-prod.yaml](https://git.ucloudadmin.com/aigc/modelverseserver/-/blob/main/deploy/deploy-prod.yaml)
>

```yaml
---
apiVersion: coordination.k8s.io/v1
kind: Lease
metadata:
  name: uminfer-proxy-lease-prod
  namespace: uminfer
spec:
  leaseDurationSeconds: 60
  leaseTransitions: 190
---
apiVersion: v1
kind: Service
metadata:
  name: uminfer-proxy
  namespace: uminfer
  labels:
    app: uminfer-proxy
spec:
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 8080
    - name: https
      protocol: TCP
      port: 443
      targetPort: 8443
  selector:
    app: uminfer-proxy
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: uminfer-proxy-config
  namespace: uminfer
data:
  config.yaml: |
    addr: ":8080"
    skipTls: false
    skipDun163: true
    isGray: false
    redis:
      address: "10.60.50.160:6379"
      password: "V********"
    mysql:
      master: "root:E******UZ9@tcp(10.11.13.115:3306)/aigc_modelverse?charset=utf8mb4&parseTime=True&loc=Local"
      slaves:
      - "root:ECZ******eAUZ9@tcp(10.11.31.42:3306)/aigc_modelverse?charset=utf8mb4&parseTime=True&loc=Local"
    taskPollerConfig:
      interval: 10
      workerCount: 50
      taskTimeout: 5
    kubeconfigPath: "/etc/uminfer-proxy/kubeconfig"
  kubeconfig: |-
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: LS0tLS1CRUdJT************0tCg==
        server: https://107.150.104.109:6443
      name: kubernetes
    contexts:
    - context:
        cluster: kubernetes
        user: admin
      name: kubernetes
    current-context: kubernetes
    kind: Config
    preferences: {}
    users:
    - name: admin
      user:
        client-certificate-data: LS0tLS1****LbXh******TkQgQ0VSVElGSUNBVEUtLS0tLQo=
        client-key-data: LS0tLS1C***tRU5E**********RFIEtFWS0tLS0tCg==
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: uminfer-proxy
  namespace: uminfer
spec:
  replicas: 3
  selector:
    matchLabels:
      app: uminfer-proxy
  template:
    metadata:
      labels:
        app: uminfer-proxy
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      terminationGracePeriodSeconds: 120
      volumes:
        - name: config
          configMap:
            name: uminfer-proxy-config
            defaultMode: 420
        - name: tls
          secret:
            secretName: uminfer-cert-20250926
            defaultMode: 400
      containers:
        - name: uminfer-proxy
          image: uhub.service.ucloud.cn/uk8s/uminfer-proxy:latest
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -c
            - --
          args:
            - /root/uminfer-proxy
          env:
            - name: TLS_CERTS_DIR
              value: "/etc/uminfer-proxy-certs/" # TLS挂载目录
            - name: TENCENT_SECRET_ID
              value: AKID******PHIKBn
            - name: TENCENT_SECRET_KEY
              value: QmB******k14sTq
            - name: BING_WEB_SEARCH_ADDR
              value: http://localhost:8650/search
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: LEASE_NAME
              value: "uminfer-proxy-lease-prod"
          resources:
            limits:
              cpu: "2"
              memory: "4Gi"
            requests:
              memory: "512Mi"
              cpu: "500m"
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 120"] # 让旧连接有足够的时间完成
          volumeMounts:
            - name: config
              mountPath: /etc/uminfer-proxy
            - name: tls
              readOnly: true
              mountPath: /etc/uminfer-proxy-certs/
        - name: bing-agent
          image: uhub.service.ucloud.cn/bithub/uminfer-bing:v1.0.3
          env:
            - name: TZ
              value: Asia/Shanghai
            - name: AZURE_ID
              value: 2b7d44******24024685
            - name: AZURE_SECRET
              value: LTh8******vmXNb_p
            - name: TENANT_ID
              value: 8390b3fe-3bdb-44d0-a4f7-f39008375aff
            - name: CONN_STR
              value: >-
                japaneast.api.azureml.ms;c0f098ff-b775-4884-b55d-ef59eed33b78;bingsearch;groundingbing
          resources:
            limits:
              cpu: "2"
              memory: 2Gi
            requests:
              cpu: "1"
              memory: 1Gi
          imagePullPolicy: Always
      restartPolicy: Always

```



### step8: kubectl -n kube-system edit ds csi-ufile

```yaml

- --s3-opt=-o use_path_request_style -o curldbg -o allow_other -o nomixupload -o retries=1 -o multipart_size=8 -o multireq_max=8 -o mp_umask=000 -o umask=000 -o parallel_count=99

```





### step9: 
