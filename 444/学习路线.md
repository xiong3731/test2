## tlias
```shell
variables:
  IMAGE_NAME: "hub.ucloudadmin.com/public/alpine:3.13.1"
  RUNNER_TAG: "uaek-c1"
  DOCKER_PASSWORD: "${PASSWORD}"
  DOCKER_USERNAME: "shaowei.xiong@ucloud.cn"
  DOCKER_HUB: "uhub.service.ucloud.cn/xiong"
  
#   KUN_IMAGE_PUSH_SECRET_NAME: $DOCKER_PASSWORD
#   KUN_USER: shaowei.xiong
#   KUN_NAMESPACE: prj-test20250313
#   KUN_PASSWORD: 7431q7f3evv0726ohsny7193qkgrtyd9
stages: 
  - build_jar
  - test_jar
  - deploy
  - build_push_image
  - ProductionDeploy
build-job:
  image: uhub.service.ucloud.cn/xiong/maven:3.8.5-openjdk-17
  stage: build_jar
  variables: 
    MAVEN_OPTS: "-Dmaven.repo.local=/root/.m2/repository"
  script:
    - |
        mvn clean install 
  artifacts:
    paths:
      - target/
  cache:
    paths:
      - /root/.m2/repository
  tags:
    - $RUNNER_TAG
test-job1:
  image: uhub.service.ucloud.cn/xiong/openjdk:17
  stage: test_jar
  script:
    - |
        java -jar target/springboot-web-management-0.0.1-SNAPSHOT.jar > output.log 2>&1 &
        sleep 10
        if grep "Started SpringbootWebManagementApplication" output.log; then
          echo "Test passed: Application started successfully."
        else
          echo "Test failed: Application did not start."
          cat output.log
          exit 1
        fi
  tags:
    - $RUNNER_TAG
  allow_failure: false

deploy-prod:
  image: hub.ucloudadmin.com/uaek/uaek-kaniko-executor:latest
  stage: build_push_image
  before_script:
    - |
        imageTag=$(date +%Y%m%d%H%M)
        imageName="$DOCKER_HUB/tlias"
        echo -e "imageTag=$imageTag\nimageName=$imageName"
        echo -e "imageTag=$imageTag\nimageName=$imageName" > .env
  script:
    - |
        cat > /kaniko/.docker/config.json << 'EOF'
        {
        "auths": {
                "uhub.service.ucloud.cn": {
                        "auth": "c2hhb3dlaS54aW9uZ0B1Y2xvdWQuY246WHN3MjAwMzA3MzE="
                }
          }
        }
        EOF
        /kaniko/executor -c $CI_PROJECT_DIR -f Dockerfile -d $imageName:$imageTag -d $imageName:latest
        echo "image is $imageName:$imageTag"
        echo "CI_PROJECT_DIR is $CI_PROJECT_DIR"
  tags:
    - $RUNNER_TAG
  artifacts:
    reports:
      dotenv: .env

# 正式发布，将部署在 uae-c3 集群的 prj-test-zxz 项目下，资源集为 ci-test
production-deploy:
  tags:
    - $RUNNER_TAG
  stage: ProductionDeploy
  image: hub.ucloudadmin.com/uaek/uaek-ciclient:latest
  variables:
    CD_CLUSTER: "uae-c3"                # kun控制台-->集群信息
    CD_PROJECT: prj-test20250313            # kun控制台-->容器-->项目管理
    CD_RESOURCESET: test-ci       # kun控制台-->发布-->项目-->资源集
    CD_FILE: tlias.yaml                   # 用来部署的k8s资源清单
    CD_USERNAME: shaowei.xiong          # 用户名（邮箱前缀）
    CD_PASSWORD: 7431q7f3evv0726ohsny7193qkgrtyd9     # UAEK 授权码
    CD_CREATE_JOB: "true"  # 设置为 false，部署任务不会被自动创建，用户需要在 KUN 控制台上手工创建 https://kun.ucloudadmin.com/deploy/resourceset
  script:
    - |
        echo "镜像名为$imageName:$imageTag"
        sed -i "s|.IMAGE|$imageName:$imageTag|" $CD_FILE
        cd $CI_PROJECT_DIR && /root/ciclient -version=$imageTag
```

## tlias-fe
```shell
variables:
  IMAGE_NAME: "hub.ucloudadmin.com/public/alpine:3.13.1"
  RUNNER_TAG: "uaek-c1"
  DOCKER_PASSWORD: "${PASSWORD}"
  DOCKER_USERNAME: "shaowei.xiong@ucloud.cn"
  DOCKER_HUB: "uhub.service.ucloud.cn/xiong"
  
#   KUN_IMAGE_PUSH_SECRET_NAME: $DOCKER_PASSWORD
#   KUN_USER: shaowei.xiong
#   KUN_NAMESPACE: prj-test20250313
#   KUN_PASSWORD: 7431q7f3evv0726ohsny7193qkgrtyd9
stages: 
  - build
  - build_push_image
  - ProductionDeploy
build-job:
  image:  uhub.service.ucloud.cn/xiong/node:18
  stage: build
  script:
    - |
        npm install
        npm run build
        chmod 755 -R dist/*
        ls dist/
  artifacts:
    paths:
      - dist/
  tags:
    - $RUNNER_TAG

deploy-prod:
  image: hub.ucloudadmin.com/uaek/uaek-kaniko-executor:latest
  stage: build_push_image
  before_script:
    - |
        imageTag=$(date +%Y%m%d%H%M)
        imageName="$DOCKER_HUB/tlias-fe"
        echo -e "imageTag=$imageTag\nimageName=$imageName"
        echo -e "imageTag=$imageTag\nimageName=$imageName" > .env
  script:
    - |
        cat > /kaniko/.docker/config.json << 'EOF'
        {
        "auths": {
                "uhub.service.ucloud.cn": {
                        "auth": "c2hhb3dlaS54aW9uZ0B1Y2xvdWQuY246WHN3MjAwMzA3MzE="
                }
          }
        }
        EOF
        /kaniko/executor -c $CI_PROJECT_DIR -f Dockerfile -d $imageName:$imageTag -d $imageName:latest
        echo "image is $imageName:$imageTag"
        echo "CI_PROJECT_DIR is $CI_PROJECT_DIR"
  tags:
    - $RUNNER_TAG
  artifacts:
    reports:
      dotenv: .env

# 正式发布，将部署在 uae-c3 集群的 prj-test-zxz 项目下，资源集为 ci-test
production-deploy:
  tags:
    - $RUNNER_TAG
  stage: ProductionDeploy
  image: hub.ucloudadmin.com/uaek/uaek-ciclient:latest
  variables:
    CD_CLUSTER: "uae-c3"                # kun控制台-->集群信息
    CD_PROJECT: prj-test20250313            # kun控制台-->容器-->项目管理
    CD_RESOURCESET: test-ci       # kun控制台-->发布-->项目-->资源集
    CD_FILE: tlias-fe.yaml                   # 用来部署的k8s资源清单
    CD_USERNAME: shaowei.xiong          # 用户名（邮箱前缀）
    CD_PASSWORD: 7431q7f3evv0726ohsny7193qkgrtyd9     # UAEK 授权码
    CD_CREATE_JOB: "true"  # 设置为 false，部署任务不会被自动创建，用户需要在 KUN 控制台上手工创建 https://kun.ucloudadmin.com/deploy/resourceset
  script:
    - |
        echo "镜像名为$imageName:$imageTag"
        sed -i "s|.IMAGE|$imageName:$imageTag|" $CD_FILE
        cd $CI_PROJECT_DIR && /root/ciclient -version=$imageTag
```

## 部分记录
创建tlias和tlias-fe的仓库

```plain
docker login hub.ucloudadmin.com 
docker login uhub.service.ucloud.cn -u shaowei.xiong@ucloud.cn -p ${PASSWORD}
docker tag maven:3.9.9 uhub.service.ucloud.cn/xiong/maven:3.9.9
docker push uhub.service.ucloud.cn/xiong/maven:3.9.9
```

http://8080.tlias-svc.prj-test20250313.svc.c3.u4/

http://80.tlias-fe-svc.prj-test20250313.svc.c3.u4/

3306.tlias-mysql-svc.prj-test20250313.svc.c3.u4

```plain
 echo 'upstream backend {
        server 127.0.0.1;
}
server{
        listen 81;
        server_name _;
        root   /usr/share/nginx/html;

        location / {
            index  index.html index.htm;
        }
        location ^~ /api/ {
                rewrite ^/api/(.*)$ /$1 break;
                proxy_pass http://backend;
        }
        
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
        }                                  
 } ' > /etc/nginx/conf.d/default.conf
```

### mysql
```shell
kubectl create secret generic mysql-password \
  --namespace=prj-test20250313 \
  --from-literal=mysql_root_password=${PASSWORD} \
  --dry-run=client -o yaml > mysqlpass-secret.yaml

```

```shell
[mysqld]
skip-host-cache
skip-name-resolve
datadir          = /var/lib/mysql
socket           = /var/run/mysqld/mysqld.sock
secure-file-priv = /var/lib/mysql-files
pid-file         = /var/run/mysqld/mysqld.pid
user             = mysql
secure-file-priv = NULL
server-id        = 1
log-bin          = master-bin
log_bin_index    = master-bin.index
#binlog_do_db     = xiaohh_user
binlog_ignore_db = information_schema
binlog_ignore_db = mysql
binlog_ignore_db = performance_schema
binlog_ignore_db = sys
binlog-format    = ROW

[client]
socket           = /var/run/mysqld/mysqld.sock

!includedir /etc/mysql/conf.d/
```

```shell
kubectl create configmap mysql-master-cm \
  -n prj-test20250313 \
  --from-file=my.cnf \
  --dry-run=client -o yaml > mysqlmaster-confmap.yaml
```

```shell
---
apiVersion: v1
kind: Service
metadata:
  name: tlias-mysql-svc
  namespace: prj-test20250313
  labels:
    app: mysql-master
spec:
  ports:
  - port: 3306
    name: mysql
    targetPort: 3306
  selector:
    app: mysql-master
  type: ClusterIP
  sessionAffinity: ClientIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: deploy-mysql-master
  namespace: prj-test20250313
spec:
  selector:
    matchLabels:
      app: mysql-master
  serviceName: "deploy-mysql-master-svc"
  replicas: 1
  template:
    metadata:
      labels:
        app: mysql-master
    spec:
      terminationGracePeriodSeconds: 10
      containers:
      - args:
        - --character-set-server=utf8mb4
        - --collation-server=utf8mb4_unicode_ci
        - --lower_case_table_names=1
        - --default-time_zone=+8:00
        name: mysql
        image: uhub.service.ucloud.cn/xiong/mysql:8.0.41
        # image: registry.cn-hangzhou.aliyuncs.com/hujiaming/mysql:8.0.34
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-conf
          mountPath: /etc/my.cnf
          readOnly: true
          subPath: my.cnf
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              key: mysql_root_password
              name: mysql-password
      volumes:
#      - name: mysql-data
#        persistentVolumeClaim:
#          claimName: deploy-mysql-master-nfs-pvc
      - name: mysql-conf
        configMap:
          name: mysql-master-cm
          items:
          - key: my.cnf
            mode: 0644
            path: my.cnf
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "udisk-sata-ap03"
      resources:
        requests:
          storage: 1Gi
```

